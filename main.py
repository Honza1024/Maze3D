import pygame as pg
import pygame.key as key
import pygame.mouse as mouse
import time
import math
import draw
import mapa
from player_class import Player
from debug import *


width, height = 400, 300
screen = pg.display.set_mode((width, height))
pg.display.set_caption("Maze3D")
surface = pg.display.set_mode((width, height))

mouse.set_visible(False)
pg.event.set_grab(True)


mapArray = mapa.create(100, 100, (
                      "...................................................................................................."
                      "..........w........................................................................................."
                      "..........w........................................................................................."
                      "..........w........................................................................................."
                      "..........w........................................................................................."
                      "..........w........................................................................................."
                      "..........w........................................................................................."
                      "..........w........................................................................................."
                      "..........w........................................................................................."
                      "..........w........................................................................................."
                      "wwwwwwwwww.........................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."
                      "...................................................................................................."))
if DEBUG: mapa.show(mapArray)

player = Player((2, 2), 0)

lastFrame = 0

state = True

while state:
    dTime = time.time() - lastFrame
    lastFrame = time.time()
    if DEBUG: print(player.position[0], player.position[1], player.direction)
    keys = key.get_pressed()
    mouseMovement = mouse.get_rel()[0]

    player.direction = (player.direction + dTime * mouseMovement * player.sensitivity) % (2 * math.pi)

    if keys[pg.K_e]:
        player.direction = (player.direction + dTime * 1) % (2 * math.pi)
    if keys[pg.K_q]:
        player.direction = (player.direction + dTime * -1) % (2 * math.pi)
    if keys[pg.K_w]:
        player.position[0] += player.speed * dTime * math.cos(player.direction)
        player.position[1] += player.speed * dTime * math.sin(player.direction)
    if keys[pg.K_s]:
        player.position[0] -= player.speed * dTime * math.cos(player.direction)
        player.position[1] -= player.speed * dTime * math.sin(player.direction)
    if keys[pg.K_d]:
        player.position[1] += player.speed * dTime * math.cos(player.direction)
        player.position[0] -= player.speed * dTime * math.sin(player.direction)
    if keys[pg.K_a]:
        player.position[1] -= player.speed * dTime * math.cos(player.direction)
        player.position[0] += player.speed * dTime * math.sin(player.direction)

    player.collide(mapArray)


    draw.frame(surface, screen, width, height, mapArray, player)
    pg.display.flip()
    for event in pg.event.get():
        if event.type == pg.QUIT:
            state = False
            pg.quit()
        elif event.type == pg.KEYDOWN:
            if event.key == pg.K_ESCAPE:
                state = 0
                mouse.set_visible(True)
                pg.event.set_grab(False)
                pg.quit()
